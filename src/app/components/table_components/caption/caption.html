<div style="display: flex; flex-direction: row; justify-content: space-between; align-items: center; gap: 1rem">
  <!-- Left side: Filter, Title, and Grouping -->
  <div style="display: flex; align-items: center; gap: 1rem">
    @if (showFilter()) {
    <p-button [outlined]="true" icon="pi pi-filter" (click)="menu.toggle($event)" />

    <p-popover #menu>
      <div class="caption-filter-popover-container">
        @for (field of fieldsVar(); track ($index + 'caption_filter')) {
        <p-floatlabel variant="on">
          <input pInputText [id]="'on_label_' + $index" [(ngModel)]="field.var" />
          <label [for]="'on_label_' + $index"> {{ field.label }}</label>
        </p-floatlabel>
        }
      </div>

      <div class="caption-filter-action-container">
        <p-button label="Clear" (click)="clear()" outlined />
        <p-button label="Search" (click)="search()" />
      </div>
    </p-popover>
    }

    <!-- Group By Selector -->
    @if (groupingEnabled() && availableGroupFields().length > 0) {
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <p-select
          [(ngModel)]="selectedGroupField"
          [options]="availableGroupFields()"
          optionLabel="header"
          optionValue="field"
          placeholder="Group By"
          [showClear]="true"
          (onChange)="onGroupChange($event.value)"
          [style]="{'min-width': '150px'}"
        >
          <ng-template let-option #item>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <i class="pi pi-table"></i>
              <span>{{ option.header }}</span>
            </div>
          </ng-template>
        </p-select>
        
        <!-- Expand/Collapse All buttons -->
        @if (selectedGroupField()) {
          <p-button
            icon="pi pi-plus"
            [text]="true"
            [rounded]="true"
            size="small"
            pTooltip="Expand All"
            (onClick)="onExpandAll.emit()"
          />
          <p-button
            icon="pi pi-minus"
            [text]="true"
            [rounded]="true"
            size="small"
            pTooltip="Collapse All"
            (onClick)="onCollapseAll.emit()"
          />
        }
      </div>
}

    
    @if (title()) {
    <p style="margin: 0">{{ table().totalRecords }} {{ title() }}</p>
    }
  </div>

  <!-- Middle: Filter Chips -->
  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap">
    @if (showFilterChips()) { 
      @for (field of appliedFilters(); track $index) { 
        @if (field.var()) {
          <p-chip>
            <span> {{ field.label }} : {{ field.var() }} </span>
            <i class="pi pi-times-circle" (click)="clearField(field.label)"></i>
          </p-chip>
        } 
      } 
    }
    
    <!--  Show active grouping as chip -->
    @if (selectedGroupField()) {
      <p-chip styleClass="bg-primary">
        <span>Grouped by: {{ selectedGroupHeader() }}</span>
        <i class="pi pi-times-circle" (click)="onGroupChange(null)"></i>
      </p-chip>
    }
  </div>

  <!-- Right side: Search and Export Buttons -->
  <div style="display: flex; align-items: center; gap: 0.5rem">
    @if (showInputSearch()) {
    <input
      pInputText
      type="text"
      [(ngModel)]="searchValue"
      (input)="table().filterGlobal(searchValue, 'contains')"
      placeholder="Search keyword"
    />
    }
    
    <!--Export Buttons - now calling local methods -->
    @if (exportButtons()) {
      <div style="display: flex; gap: 0.5rem">
        @if (exportButtons()?.csv) {
          <p-button 
            icon="pi pi-file" 
            [outlined]="true"
            severity="secondary"
            size="small"
            pTooltip="Export CSV"
            (onClick)="exportCSV()" />
        }
        @if (exportButtons()?.excel) {
          <p-button 
            icon="pi pi-file-excel" 
            [outlined]="true"
            severity="success"
            size="small"
            pTooltip="Export Excel"
            (onClick)="exportExcel()" />
        }
        @if (exportButtons()?.pdf) {
          <p-button 
            icon="pi pi-file-pdf" 
            [outlined]="true"
            severity="danger"
            size="small"
            pTooltip="Export PDF"
            (onClick)="exportPDF()" />
        }
      </div>
    }
    
    <ng-container [ngTemplateOutlet]="actionTemplate()"></ng-container>
  </div>
</div>
