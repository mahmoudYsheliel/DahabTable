<div style="display: flex; flex-direction: row; justify-content: space-between; align-items: center; gap: 1rem">
  <!-- Left side: Filter, Title, and Grouping -->
  <div style="display: flex; align-items: center; gap: 1rem">
    @if (showFilter()) {
    <p-button outlined icon="pi pi-filter-fill" (click)="menu.toggle($event)"
      [pt]="{root:{style:'color:#ec1c34;border:#B0BEC5 solid 1px;background-color:transparent'}}" />

    <p-popover #menu [pt]="{content:{style:'padding:0 ;font-family:Roboto , sans-serif'}}">
      <div>
        <div class="caption-filter-popover-container">
          <div class="caption-filter-header">
            <h4 class="caption-filter-title">Filters</h4>
            <p-button (click)="menu.toggle($event)" icon="pi pi-times"
              [pt]="{root:{style:'color:#868889;background-color:transparent'}}" outlined text />
          </div>

          <div class="caption-filter-content">
            @for (field of fieldsVar(); track ($index + 'caption_filter')) {
            <p-floatlabel variant="on">
              <input pInputText class="filter-input-field" [id]="'on_label_' + $index" [(ngModel)]="field.var" />
              <label class="filter-label" [for]="'on_label_' + $index"> {{ field.label }}</label>
            </p-floatlabel>
            }
          </div>

          <div class="caption-filter-footer">
            <p-button [pt]="{root:{style:'color:#263238;background-color:transparent'},label:{class:['!test']}}"
              label="Clear" (click)="clear()" outlined text />
            <p-button [pt]="{ root:{style:'color:white;background-color:#ec1c34;height:2rem'}}" label="Search"
              (click)="search()" text />
          </div>


        </div>
      </div>


    </p-popover>
    }



    <!-- Group By Selector -->
    @if (groupingEnabled() && availableGroupFields().length > 0) {
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <p-select [(ngModel)]="selectedGroupField" [options]="availableGroupFields()" optionLabel="header"
        optionValue="field" placeholder="Group By" [showClear]="true" (onChange)="onGroupChange($event.value)"
        [style]="{'min-width': '150px'}">
        <ng-template let-option #item>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="pi pi-table"></i>
            <span>{{ option.header }}</span>
          </div>
        </ng-template>
      </p-select>

      <!-- Expand/Collapse All buttons -->
      @if (selectedGroupField()) {
      <p-button icon="pi pi-plus" [text]="true" [rounded]="true" size="small" pTooltip="Expand All"
        (onClick)="onExpandAll.emit()" />
      <p-button icon="pi pi-minus" [text]="true" [rounded]="true" size="small" pTooltip="Collapse All"
        (onClick)="onCollapseAll.emit()" />
      }
    </div>
    }


    @if (title()) {
    <p class="caption-title">{{ table()?.totalRecords }} {{ title() }}</p>
    }
  </div>

  <!-- Middle: Filter Chips -->
  <div class="filter-chip-container">
    @if (showFilterChips()) {
    @for (field of appliedFilters(); track $index) {
    @if (field.var()) {
    <p-chip class="filter-chip">
      <span> {{ field.label }} : {{ field.var() }} </span>
      <i class="pi pi-times-circle" (click)="clearField(field.label)"></i>
    </p-chip>
    }
    }
    }

    <!--  Show active grouping as chip -->
    @if (selectedGroupField()) {
    <p-chip>
      <span>Grouped by: {{ selectedGroupHeader() }}</span>
      <i class="pi pi-times-circle" (click)="onGroupChange(null)"></i>
    </p-chip>
    }
  </div>

  <!-- Right side: Search and Export Buttons -->
  <div style="display: flex; align-items: center; gap: 0.5rem">
    @if (showInputSearch()) {


    <p-iconfield>
      <p-inputicon class="pi pi-search" />
      <input pInputText type="text" [(ngModel)]="searchValue" (input)="table()?.filterGlobal(searchValue, 'contains')"
        placeholder="Search" style="height: 2rem;" />
    </p-iconfield>
    }

    <!--Export Buttons - now calling local methods -->
    @if (exportButtons()) {
    <div style="display: flex; gap: 0.5rem">
      @if (exportButtons()?.csv) {
      <p-button icon="pi pi-file" [outlined]="true" severity="secondary" size="small" pTooltip="Export CSV"
        (onClick)="exportCSV()" />
      }
      @if (exportButtons()?.excel) {
      <p-button icon="pi pi-file-excel" [outlined]="true" severity="success" size="small" pTooltip="Export Excel"
        (onClick)="exportExcel()" />
      }
      @if (exportButtons()?.pdf) {
      <p-button pTooltip="Upload Ecel" icon="pi pi-file-pdf" [outlined]="true" severity="danger" size="small"
        pTooltip="Export PDF" (onClick)="exportPDF()" />
      }
      @if (importable()) {
         <input type="file" #fileInput accept=".xlsx,.xls" style="display: none" (change)="onFileSelected($event)" />
      <p-button type="button" (click)="fileInput.click()" icon="pi pi-upload" outlined />

      }

    </div>
    }

    <ng-container [ngTemplateOutlet]="actionTemplate()"></ng-container>
  </div>
</div>